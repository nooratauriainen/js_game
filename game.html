<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Brick game</title>
  <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }

      button { position: absolute; transition: .5s ease;
        left: 68%;
        top: 56%;
        background-color: black;
        border-radius: 4px;
        color: white;
        padding: 4px 10px;
        text-align: center;
        text-decoration: none;
        font-family: Impact;
        font-size: 20px;
      }

   </style>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>
<body>

  <canvas id="myCanvas" width="480" height="320"></canvas>
  <button id="Save">Save</button>

  <script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var brickRowCount = 3;
    var brickColumnCount = 6;
    var brickWidth = 65;
    var brickHeight = 15;
    var brickPadding = 10;
    var brickOffsetTop = 30;
    var brickOffsetLeft = 18;
    var bricks = [];
    for(c=0; c<brickColumnCount; c++) {
        bricks[c] = [];
        for(r=0; r<brickRowCount; r++) {
            bricks[c][r] = { x: 0, y: 0, status: 1 };
        }
    }

    var message1 = {
      messageType: "SETTING",
      options: {
        "width": canvas.width,
        "height": canvas.height
      }
    };
    window.parent.postMessage(message1, "*");
    var message2 = {
      messageType: "LOAD_REQUEST",
    };
    window.parent.postMessage(message2, "*");

    function receiveMessage(e) {

      if (e.data.messageType == "LOAD") {
        console.log(e.data.gameState.score);
        console.log(e.data.gameState.playerItems);
        score = parseInt(e.data.gameState.score);
        lives = parseInt(e.data.gameState.playerItems.charAt(0));
        var i = 1;
        for(c=0; c<brickColumnCount; c++) {
            for(r=0; r<brickRowCount; r++) {
              bricks[c][r].status = parseInt(e.data.gameState.playerItems.charAt(i));
              i = i+1;
            }
          }

        play = false;
      } else if (e.data.messageType == "ERROR") {
          alert(e.data.info);
      }
    }

    window.addEventListener("message", receiveMessage, false);

    var score = 0;
    var lives = 3;
    var play = false;
    var x = canvas.width/2;
    var y = canvas.height-30;
    var dx = 2;
    var dy = -2;
    var ballRadius = 10;
    var paddleHeight = 10;
    var paddleWidth = 75;
    var paddleX = (canvas.width-paddleWidth)/2;
    var rightPressed = false;
    var leftPressed = false;

    function setBackground(){
        var grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grd.addColorStop(0.3, "darkblue");
        grd.addColorStop(0.9, "lightblue");
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for(c=0; c<brickColumnCount; c++) {
            for(r=0; r<brickRowCount; r++) {
              if(bricks[c][r].status == 1) {
                var brickX = (c*(brickWidth+brickPadding))+brickOffsetLeft;
                var brickY = (r*(brickHeight+brickPadding))+brickOffsetTop;
                bricks[c][r].x = brickX;
                bricks[c][r].y = brickY;
                ctx.beginPath();
                ctx.rect(brickX, brickY, brickWidth, brickHeight);
                if (r == 0) {
                  ctx.fillStyle = "#FF1493";
                } else if (r == 1){
                  ctx.fillStyle = "	#FF69B4";
                } else {
                  ctx.fillStyle = "#FFC0CB";
                }
                ctx.fill();
                ctx.closePath();
              }
            }
        }

        ctx.font = "22px Impact";
        ctx.fillStyle = "white";
        ctx.fillText("Score: "+score, canvas.width*0.75, canvas.height*0.07);
        ctx.fillText("â™¥: "+lives, canvas.width*0.05,  canvas.height*0.07);
    }
    function drawBall() {
      ctx.beginPath();
      ctx.arc(x, y, ballRadius, 0, Math.PI*2);
      var c = document.getElementById("myCanvas");
      var grd = ctx.createRadialGradient(x, y, 1, x, y, ballRadius);
      grd.addColorStop(0, "pink");
      grd.addColorStop(0.9, "red");
      ctx.fillStyle = grd;
      ctx.fill();
      ctx.closePath();
    }
    function drawPaddle() {
      ctx.beginPath();
      ctx.rect(paddleX, canvas.height-paddleHeight, paddleWidth, paddleHeight);
      ctx.fillStyle = "black";
      ctx.fill();
      ctx.closePath();
    }
    function collisionDetection() {
      for(c=0; c<brickColumnCount; c++) {
          for(r=0; r<brickRowCount; r++) {
              var b = bricks[c][r];
              if(x+ballRadius > b.x && x-ballRadius < b.x+brickWidth && y+ballRadius > b.y && y-ballRadius < b.y+brickHeight && b.status == 1) {
                dy = -dy;
                b.status = 0;
                if (r == 2) {
                  score++;
                } else if (r == 1) {
                  score = score+2;
                } else {
                  score = score+3;
                }
                if (score >= 36) {
                  play = false;
                }
              }
          }
      }
      if (x > paddleX-ballRadius && x < paddleX+paddleWidth+ballRadius && y == canvas.height-paddleHeight-ballRadius) {
          dy = -dy;
      }
    }
    function startMenu() {
        document.getElementById("Save").style.display = "inline-block";
        setBackground();
        ctx.beginPath();
        ctx.rect(0.15*canvas.width, 0.4*canvas.height, 0.7*canvas.width, 0.3*canvas.height);
        ctx.fillStyle = "black";
        ctx.fill();
        ctx.closePath();
        ctx.font = "30px Impact";
        ctx.fillStyle = "white";

        if (lives == 0) {
          var msg = {
            "messageType": "SCORE",
            "score": parseFloat(score),
          }

          window.parent.postMessage(msg, "*");
          ctx.font = "30px Impact";
          ctx.fillText("Game Over", 0.25*canvas.width, 0.55*canvas.height);
          setTimeout(function(){
            lives = 3;
            score = 0;
            for(c=0; c<brickColumnCount; c++) {
                for(r=0; r<brickRowCount; r++) {
                    bricks[c][r].status =  1;
                }
            }
            x = canvas.width/2;
            y = canvas.height-30;
            paddleX = (canvas.width-paddleWidth)/2;
          }, 2000);
        } else if (score >= 36) {
          var msg = {
            "messageType": "SCORE",
            "score": parseFloat(score),
          }
          window.parent.postMessage(msg, "*");
          ctx.font = "30px Impact";
          ctx.fillText("You win!", 0.25*canvas.width, 0.55*canvas.height);
          setTimeout(function(){
            lives = 3;
            score = 0;
            for(c=0; c<brickColumnCount; c++) {
                for(r=0; r<brickRowCount; r++) {
                    bricks[c][r].status =  1;
                }
            }
            x = canvas.width/2;
            y = canvas.height-30;
            paddleX = (canvas.width-paddleWidth)/2;
          }, 2000);
        } else {
          ctx.fillText("Press P -> Play/Pause", 0.20*canvas.width, 0.51*canvas.height);
          ctx.fillText("Press Q -> Quit",  0.20*canvas.width, 0.63*canvas.height);
        }
    }

    function draw() {
      if (play == false) {
        startMenu();
      } else {
        document.getElementById("Save").style.display = "none";
        setBackground();
        drawBall();
        drawPaddle();
        collisionDetection();
        if(rightPressed && paddleX < canvas.width-paddleWidth) {
            paddleX += 6;
        }
        else if(leftPressed && paddleX > 0) {
            paddleX -= 6;
        }
        if(y + dy < ballRadius) {
            dy = -dy;
        } else if(y + dy > canvas.height-ballRadius) {
          lives -= 1;
          if (lives == 0){
            play = false;
          } else {
            x = canvas.width/2;
            y = canvas.height-30;
            dx = 2;
            dy = -2;
            paddleX = (canvas.width-paddleWidth)/2;
          }
        }
        if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) {
            dx = -dx;
        }
        x += dx;
        y += dy;
      }
        requestAnimationFrame(draw);
      }

  document.addEventListener("keydown", PlayPauseHandler, false);
  document.addEventListener("keydown", keyDownHandler, false);
  document.addEventListener("keyup", keyUpHandler, false);
  document.addEventListener("mousemove", mouseMoveHandler, false);
  document.getElementById('Save').addEventListener("click", SaveHandler);

  function PlayPauseHandler(e) {
    if(e.keyCode == 80 && play == false) {
       play = true;
      }
    else if(e.keyCode == 80 && play == true) {
        play = false;
      }
  }

  function SaveHandler(e) {

      var playerItems = String(lives);
      for(c=0; c<brickColumnCount; c++) {
          for(r=0; r<brickRowCount; r++) {
            playerItems = playerItems.concat(String(bricks[c][r].status));
          }
        }
      var msg = {
        messageType: "SAVE",
        gameState: {
            "playerItems": playerItems,
            "score": score,
        }
      };
      window.parent.postMessage(msg, "*");
    }

  window.addEventListener("keydown", QuitHandler, true);


  function QuitHandler(e) {
    if(e.keyCode == 81 && play == true) {
       play = false;
       score = 0;
       lives = 3;
       for(c=0; c<brickColumnCount; c++) {
        for(r=0; r<brickRowCount; r++) {
          bricks[c][r].status =  1;
          }
        }
      }
    }
  function keyDownHandler(e) {
    if(e.keyCode == 39) {
        rightPressed = true;
      }
    else if(e.keyCode == 37) {
        leftPressed = true;
      }
    }

  function keyUpHandler(e) {
      if(e.keyCode == 39) {
          rightPressed = false;
      }
      else if(e.keyCode == 37) {
          leftPressed = false;
      }
  }

  function mouseMoveHandler(e) {
    var relativeX = e.clientX - canvas.offsetLeft;
    if(relativeX > paddleWidth/2 && relativeX < canvas.width- paddleWidth/2) {
        paddleX = relativeX - paddleWidth/2;
    }
  }



  function receiveMessage(e) {

    if (e.data.messageType == "LOAD") {
      score = parseInt(e.data.gameState.score);
      lives = parseInt(e.data.gameState.playerItems.charAt(0));
      var i = 1;
      for(c=0; c<brickColumnCount; c++) {
          for(r=0; r<brickRowCount; r++) {
            bricks[c][r].status = parseInt(e.data.gameState.playerItems.charAt(i));
            i = i+1;
          }
        }

      play = false;
    } else if (e.data.messageType == "ERROR") {
        alert(e.data.info);

    }
  }

  document.addEventListener("message", receiveMessage, false);
  draw();

  </script>


</body>
</html>

